<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 동네 아파트 실거래가 대시보드</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for robust CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* 커스텀 스크롤바 스타일링 */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- 헤더 영역 -->
        <header class="flex justify-between items-end pb-4 border-b border-slate-200">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">우리 동네 아파트 실거래가 대시보드</h1>
                <p class="text-sm text-slate-500 mt-2">구글 스프레드시트 연동 기반 실시간 데이터 분석</p>
            </div>
            <div id="loading-indicator" class="text-emerald-600 font-semibold flex items-center gap-2">
                <svg class="animate-spin h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                데이터 불러오는 중...
            </div>
        </header>

        <!-- 요약 지표 (KPI Cards) 영역 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- 전체 거래 건수 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center">
                <span class="text-sm font-medium text-slate-500 mb-1">전체 거래 건수</span>
                <div class="flex items-baseline gap-1">
                    <span id="kpi-count" class="text-3xl font-bold text-slate-800">-</span>
                    <span class="text-slate-500 font-medium">건</span>
                </div>
            </div>
            <!-- 평균 거래가격 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center">
                <span class="text-sm font-medium text-slate-500 mb-1">평균 거래가격</span>
                <div class="flex items-baseline gap-1">
                    <span id="kpi-avg" class="text-3xl font-bold text-emerald-600">-</span>
                    <span class="text-slate-500 font-medium">만원</span>
                </div>
            </div>
            <!-- 최고 거래가격 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center">
                <span class="text-sm font-medium text-slate-500 mb-1">최고 거래가격</span>
                <div class="flex items-baseline gap-1">
                    <span id="kpi-max" class="text-3xl font-bold text-red-500">-</span>
                    <span class="text-slate-500 font-medium">만원</span>
                </div>
            </div>
            <!-- 최저 거래가격 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center">
                <span class="text-sm font-medium text-slate-500 mb-1">최저 거래가격</span>
                <div class="flex items-baseline gap-1">
                    <span id="kpi-min" class="text-3xl font-bold text-blue-500">-</span>
                    <span class="text-slate-500 font-medium">만원</span>
                </div>
            </div>
        </div>

        <!-- 메인 콘텐츠 영역 (차트 & 테이블) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- 월별 평균 거래가격 차트 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-1 flex flex-col">
                <h2 class="text-lg font-bold text-slate-800 mb-4">월별 평균 거래가격 추이</h2>
                <div class="relative flex-1 w-full min-h-[300px]">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- 거래 목록 테이블 -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 lg:col-span-2 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white">
                    <h2 class="text-lg font-bold text-slate-800">상세 거래 목록</h2>
                    <span class="text-xs text-slate-400">최근 거래일 순</span>
                </div>
                <!-- 테이블 스크롤 영역 -->
                <div class="table-container overflow-auto h-[400px] lg:h-[500px] w-full relative">
                    <table class="w-full text-left border-collapse min-w-[700px]">
                        <thead class="bg-slate-50 sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="py-3 px-4 font-semibold text-sm text-slate-600 border-b">거래일자</th>
                                <th class="py-3 px-4 font-semibold text-sm text-slate-600 border-b">아파트명</th>
                                <th class="py-3 px-4 font-semibold text-sm text-slate-600 border-b">법정동</th>
                                <th class="py-3 px-4 font-semibold text-sm text-slate-600 border-b text-right">전용면적(㎡)</th>
                                <th class="py-3 px-4 font-semibold text-sm text-slate-600 border-b text-center">층</th>
                                <th class="py-3 px-4 font-semibold text-sm text-slate-600 border-b text-right">거래금액(만원)</th>
                                <th class="py-3 px-4 font-semibold text-sm text-slate-600 border-b text-center">건축년도</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100">
                            <!-- JS로 데이터 삽입 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6yN0pKV-izGIt1DQpSP6weojvy2WoxoPC7JuQIOc3nPDp9e9fC86_o5ocuMFPHbGmDkltrScq4VoI/pub?gid=132138607&single=true&output=csv';

        document.addEventListener('DOMContentLoaded', () => {
            fetchDataAndRender();
        });

        function fetchDataAndRender() {
            // PapaParse를 이용해 CSV 데이터를 JSON 형태로 파싱
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    processData(data);
                    document.getElementById('loading-indicator').style.display = 'none';
                },
                error: function(err) {
                    console.error("데이터 로드 실패:", err);
                    document.getElementById('loading-indicator').innerHTML = '<span class="text-red-500">데이터 로드 실패</span>';
                }
            });
        }

        function processData(data) {
            let validPrices = [];
            let monthlyStats = {};
            let tableHTML = '';

            // 거래일자 기준 내림차순 정렬 (최신순)
            data.sort((a, b) => {
                const dateA = new Date(a['거래일자']?.replace(/\./g, '-') || 0);
                const dateB = new Date(b['거래일자']?.replace(/\./g, '-') || 0);
                return dateB - dateA;
            });

            data.forEach(row => {
                // 키워드 매핑 (혹시 모를 공백 등 방지)
                const dateStr = row['거래일자'] ? row['거래일자'].trim() : '';
                const aptName = row['아파트명'] || '-';
                const dong = row['법정동'] || '-';
                const area = row['전용면적(㎡)'] || '-';
                const floor = row['층'] || '-';
                const priceStr = row['거래금액(만원)'] || '0';
                const year = row['건축년도'] || '-';

                // 금액 숫자 변환 (콤마 제거)
                const price = parseInt(priceStr.replace(/,/g, ''), 10);
                
                if (!isNaN(price) && price > 0 && dateStr) {
                    validPrices.push(price);

                    // 월별 데이터 집계 (YYYY-MM 형식 추출)
                    // 거래일자 포맷(예: 2023.01.15 또는 2023-01-15 등)에서 연/월 추출
                    const dateMatch = dateStr.match(/(\d{4})[-\.\/년\s]+(\d{1,2})/);
                    if (dateMatch) {
                        const mYear = dateMatch[1];
                        const mMonth = dateMatch[2].padStart(2, '0');
                        const monthKey = `${mYear}-${mMonth}`;

                        if (!monthlyStats[monthKey]) {
                            monthlyStats[monthKey] = { sum: 0, count: 0 };
                        }
                        monthlyStats[monthKey].sum += price;
                        monthlyStats[monthKey].count += 1;
                    }

                    // 5억(50,000만원) 이상 거래금액 강조 색상 클래스
                    const priceColorClass = price >= 50000 ? 'text-red-600' : 'text-slate-800';

                    // 테이블 Row 생성 (줄무늬 패턴 및 마우스 호버 색상 추가)
                    tableHTML += `
                        <tr class="odd:bg-white even:bg-slate-50 hover:bg-emerald-50 transition-colors">
                            <td class="py-3 px-4 text-sm text-slate-600">${dateStr}</td>
                            <td class="py-3 px-4 text-sm font-medium text-slate-800">${aptName}</td>
                            <td class="py-3 px-4 text-sm text-slate-600">${dong}</td>
                            <td class="py-3 px-4 text-sm text-slate-600 text-right">${area}</td>
                            <td class="py-3 px-4 text-sm text-slate-600 text-center">${floor}</td>
                            <td class="py-3 px-4 text-sm font-bold ${priceColorClass} text-right">${price.toLocaleString()}</td>
                            <td class="py-3 px-4 text-sm text-slate-500 text-center">${year}</td>
                        </tr>
                    `;
                }
            });

            // 1. KPI 지표 업데이트
            if (validPrices.length > 0) {
                const maxPrice = Math.max(...validPrices);
                const minPrice = Math.min(...validPrices);
                const avgPrice = validPrices.reduce((a, b) => a + b, 0) / validPrices.length;

                document.getElementById('kpi-count').innerText = validPrices.length.toLocaleString();
                document.getElementById('kpi-avg').innerText = Math.round(avgPrice).toLocaleString();
                document.getElementById('kpi-max').innerText = maxPrice.toLocaleString();
                document.getElementById('kpi-min').innerText = minPrice.toLocaleString();
            }

            // 2. 테이블 업데이트
            document.getElementById('table-body').innerHTML = tableHTML;

            // 3. 차트 렌더링 준비
            const sortedMonths = Object.keys(monthlyStats).sort();
            const avgPricesByMonth = sortedMonths.map(month => {
                return Math.round(monthlyStats[month].sum / monthlyStats[month].count);
            });

            renderChart(sortedMonths, avgPricesByMonth);
        }

        // Chart.js를 이용한 월별 평균 거래가격 차트 렌더링
        let myChart = null;
        function renderChart(labels, data) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // 기존 차트가 있다면 파괴 (중복 렌더링 방지)
            if (myChart) {
                myChart.destroy();
            }

            // 그라데이션 색상 설정
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(5, 150, 105, 0.2)'); // Tailwind emerald-600
            gradient.addColorStop(1, 'rgba(5, 150, 105, 0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '평균 거래가격 (만원)',
                        data: data,
                        borderColor: '#059669', // emerald-600
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#059669',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.3 // 부드러운 곡선
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + ' 만원';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { font: { family: "'Pretendard', sans-serif" }, color: '#64748b' }
                        },
                        y: {
                            grid: { color: '#f1f5f9', drawBorder: false },
                            ticks: { 
                                font: { family: "'Pretendard', sans-serif" },
                                color: '#64748b',
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
